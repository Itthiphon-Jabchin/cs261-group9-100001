services:
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: db
    environment:
      SA_PASSWORD: "MyP@ssw0rd!1234"
      ACCEPT_EULA: "Y"
    ports:
      - "1433:1433"
    volumes:
      - mssql-data:/var/opt/mssql

  # รัน init.sql เพื่อสร้างตารางและข้อมูลเริ่มต้น เมื่อรัน docker-compose ขึ้นมา
  db-init:
    image: mcr.microsoft.com/mssql-tools
    container_name: db-init
    depends_on:
      - db
    volumes:
      - ./db:/scripts
    entrypoint: ["/bin/bash", "-c", "
      echo 'Waiting for SQL Server to start...';
      sleep 60;
      /opt/mssql-tools/bin/sqlcmd -S db -U SA -P 'MyP@ssw0rd!1234' -i /scripts/init.sql;
      echo 'Database initialized successfully!'
      "]

  # โปรไฟล์ dev: ให้เพื่อนแก้ UI แล้วเห็นผลทันที
  app-dev:
    profiles: ["dev"]
    image: maven:3.9-eclipse-temurin-17
    working_dir: /workspace
    command: mvn -DskipTests spring-boot:run -Dspring-boot.run.profiles=dev
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:sqlserver://db:1433;databaseName=${DB_NAME};trustServerCertificate=true;
      SPRING_DATASOURCE_USERNAME: ${DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      APP_SEED_ENABLED: ${APP_SEED_ENABLED}
    depends_on:
      - db
    volumes:
      - .:/workspace
      - m2:/root/.m2

  # โปรไฟล์ prod: รันด้วย JAR ที่ build จาก Dockerfile
  app:
    profiles: ["prod"]
    build: .
    image: uni-jobs-portal-app:latest
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:sqlserver://db:1433;databaseName=${DB_NAME};trustServerCertificate=true;
      SPRING_DATASOURCE_USERNAME: ${DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      APP_SEED_ENABLED: ${APP_SEED_ENABLED}
    depends_on:
      - db

volumes:
  mssql-data:
